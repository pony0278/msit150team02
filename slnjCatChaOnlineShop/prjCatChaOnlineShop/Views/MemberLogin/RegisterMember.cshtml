@{
    ViewData["Title"] = "Login";
    Layout = null;
}
<!DOCTYPE html>

<html>
<head>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!--myCss-->
    <link rel="stylesheet" href="~/css/myCss.css">
    <!-- Site CSS -->
    <link rel="stylesheet" href="~/css/style.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="~/css/responsive.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="~/css/custom.css">

    <!--日期選擇-->



    <style>
        .logo-wrapper:hover {
            transform: scale(1.1); /* 放大 10% */
            transition: transform 0.3s ease-in-out; /* 添加平滑過渡效果 */
        }

        .alert-btn-login {
            background-color: #DE9E4F !important; 
            color: white; 
        }

        .main-top .formain-topSpan {
            color: #ffffff;
            letter-spacing: 2px;
        }
    </style>


</head>

<body style="background:#F6EBDF">
    <div class="main-top">
        <div class="d-flex justify-content-center p-2">
            <ul>
                <li>
                    <i class="fab fa-opencart" style="color:#ffff"><span class="formain-topSpan"></span></i>
                </li>
            </ul>
        </div>
    </div>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-5 d-flex align-items-center justify-content-center">
                <a asp-controller="Index" asp-action="Index" class="logo-wrapper">
                    <img src="~/images/CatCha/loginlogo.png" style="width: 70%; height: auto;" />
                </a>
            </div>
            <div class="col-6 mt-2">
                <div class="text-center mt-3" style="font-size:40px">
                    <a id="loginModalLabel">註冊會員</a>
                </div>
                <div class=" row justify-content-md-center">
                    <div class="col-10">
                        <div class="">
                            <form id="registerForm">
                                <div class="row ">
                                    <div class="mb-2 form-group">
                                        <label for="Name">姓名：</label>
                                        <input type="text" class="form-control" id="registerNameText" name="Name"
                                               placeholder="姓名" required>
                                    </div>
                                    <div class="mb-2 form-group">
                                        <label for="Birthday">生日：</label>
                                        <div class="input-group date" id="datepicker">
                                            <input type="text" class="form-control " id="registerBirthText" name="Birthday" placeholder="請輸入生日" />
                                            <span class="input-group-append">
                                                <span class="input-group-text bg-light d-block">
                                                    <i class="fa-solid fa-calendar-days"></i>
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="mb-2 form-group">
                                        <label for="Email">電子信箱：</label>
                                        <input type="email" class="form-control" name="Email" id="emailInput"
                                               placeholder="email" required>
                                        <div id="emailError" class="error-message-color" style="font-size:15px; display:none;">此信箱已被註冊過</div>
                                    </div>
                                    <div class="mb-2 form-group">
                                        <label for="PhoneNumber">手機號碼：</label>
                                        <input type="text" class="form-control memberPhoneNum" name="PhoneNumber" id="registerPhoneText"
                                               placeholder="手機號碼" required>
                                    </div>
                                    <div class="mb-2 form-group">
                                        <label for="passwordInput">設定密碼：</label>
                                        <input type="password" class="form-control memberPassword" name="Password" id="passwordInput"
                                               placeholder="請設定6-15位英數字混合密碼,英文需區分大小寫" required>
                                    </div>
                                    <div class="mb-2 form-group">
                                        <label for="passwordCheck">再次確認密碼：</label>
                                        <input type="password" class="form-control memberPasswordCheck" name="PasswordCheck" id="passwordCheck"
                                               placeholder="請再輸入一次密碼" required>
                                        <div class="invalid-feedback"> 請再輸入一次密碼</div>
                                    </div>
                                </div>

                                <div class="d-grid gap-2 mt-3">
                                    <button class="mb-3 btn btn-light" id="registerbutton" type="submit" onclick="SendMailToken()">註冊</button>
                                </div>
                                <div class="d-grid gap-2 mt-3">
                                    <button class="mb-3 btn btn-light" style="display:none;" id="getVerifiedAgain" type="submit" onclick="SendMailToken()">未收到驗證信嗎?</button>
                                </div>
                                <div class="d-grid gap-2 mt-3">
                                    <button class="mb-3 btn btn-danger" id="registerdemoBTN" type="submit">DEMO帶入資料</button>
                                </div>

                            </form>
                        </div>
                        <!--<div class="modal-footer" class="row gy-4"></div>-->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Start Footer  -->
    <footer>
        <div class="footer-main mt-3">
            <div class="container">
                <div class="row">
                    <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="footer-top-box">
                            <h3>營業時間</h3>
                            <ul class="list-time">
                                <li>一 - 五: 08.00am - 05.00pm</li>
                                <li>星期六: 10.00am - 08.00pm</li>
                                <li>星期日: 11.00am - 12.00pm</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="footer-top-box">
                            <h3>訂閱我們獲得最新資訊</h3>
                            <form class="newsletter-box">
                                <div class="">
                                    <input class="" type="email" name="Email" placeholder="請輸入您的電子信箱" />
                                    <i class="fa fa-envelope"></i>
                                </div>
                                <button class="btn hvr-hover" type="submit">立即訂閱</button>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="footer-top-box">
                            <h3>追蹤我們</h3>
                            <div class="mt-3">
                                <ul>
                                    <li><a href="#"><i class="fab fa-facebook" aria-hidden="true"></i></a></li>
                                    <li><a href="#"><i class="fab fa-instagram" aria-hidden="true"></i></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="footer-widget">
                            <h4>關於CatCha貓抓抓</h4>
                            <p>致力於提供最完整的產品給貓咪。</p>
                            <p>你的寶貝也是我們的寶貝。</p>
                            <p>除了購物服務，也提供各種貓咪的知識。</p>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="footer-link">
                            <h4>顧客服務</h4>
                            <ul>
                                <li><a href="#">防詐騙宣導</a></li>
                                <li><a href="#">退換貨政策</a></li>
                                <li><a href="#">服務條款</a></li>
                                <li><a href="#">隱私權政策</a></li>
                                <li><a href="#">運送政策</a></li>
                                <li><a href="#">常見問題</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12 col-sm-12">
                        <div class="footer-link-contact">
                            <h4>聯絡我們</h4>
                            <ul>
                                <li>
                                    <p><i class="fas fa-map-marker-alt"></i>地址: 106台北市大安區 <br>復興南路一段390號2樓</p>
                                </li>
                                <li>
                                    <p><i class="fas fa-phone-square"></i>Phone: <a href="tel:02-6631-6588">02-6631-6588</a></p>
                                </li>
                                <li>
                                    <p>
                                        <i class="fas fa-envelope"></i>Email: <a href="mailto:catCha@gmail.com">catCha@gmail.com</a>
                                    </p>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- End Footer  -->
    <!-- Start copyright  -->
    <div class="footer-copyright">
        <p class="footer-company">
            All Rights Reserved. &copy; 2023 <a href="#">catCha</a>
        </p>
    </div>
    <!-- End copyright  -->

    <a href="#" id="back-to-top" title="Back to top" style="display: none;">&uarr;</a>

    <!-- ALL JS FILES -->
    <!--SWEET ALERT-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!--引用日期選擇-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <!--驗證欄位-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="~/js/registerValidate.js"></script>
    <!---->
    <!--選擇生日-->
    
       
    

    <script type="text/javascript">
        

        //日期選擇功能
        $(function () {
            $('#datepicker').datepicker();
        });
        let emailAlreadyRegistered = false; // 添加變數以追蹤是否已經註冊

        $(document).ready(function () {
            // 當輸入完電子信箱點選到其他地方(移開焦點)時執行信箱驗證
            $("#emailInput").blur(function () {
                var email = $(this).val();
                if (email != "")
                    validateEmail(email);
            });
        });

       
        // 表單驗證
        $("#registerForm").validate({
            errorClass: "error-message-color",
            submitHandler: function (form) {
                if (!emailAlreadyRegistered) { // 檢查是否已經註冊
                    event.preventDefault(); // 防止預設行為的發生
                    const formData = new FormData(form);
                    registerMember(formData);
                }
            },
            errorPlacement: function (error, element) {
                element.closest('.form-group').append(error);
            },
            rules: {
                // 可以加上特殊的規則
                PasswordCheck: {
                    equalTo: "#passwordInput"
                }
            },
            messages: {
                PasswordCheck: {
                    equalTo: "密碼不相符，請再重新輸入一次"
                }
            }
        });
                

        // 驗證電子信箱是否存在的函數
        function validateEmail(email) {
            $.ajax({
                url: '@Url.Content("~/MemberLogin/CheckEmailExist")',
                method: 'POST',
                data: { email: email },
                success: function (response) {
                    if (response) {
                        $("#emailError").show();
                        emailAlreadyRegistered = true; // 設定為已註冊
                    } else {
                        $("#emailError").hide();
                        emailAlreadyRegistered = false; // 設定為未註冊
                    }
                }
            }).catch(function (error) {
                console.error(error); // 處理Ajax錯誤
            });
        }

        // 註冊會員的函數
        function registerMember(formData) {
            const txtEmail = $('#emailInput').val();
            const txtPassword = $('#passwordInput').val();
            fetch('@Url.Content("~/MemberLogin/RegisterMember")', {
                body: formData,
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: '成功送出!',
                            text: '請至Email驗證身分以完成註冊',
                            customClass: {
                                confirmButton: 'alert-btn-login'
                            },
                            confirmButtonText: '確定'
                        });
                        $('#getVerifiedAgain').css("display", "block")//開啟未收到驗證信按鈕
                    }
                }).catch(function (error) {
                    console.error(error); // 處理Ajax錯誤
                });
        }


        // 這段 JavaScript 用於處理表單提交
        function SendMailToken() {

            // 紀錄使用者填寫的email，傳給後端用於寄送驗證信
            const emailInput = $('#emailInput').val();
            var postData = {
                MemberID: emailInput
            };

            if (!emailAlreadyRegistered){
                $.ajax({
                    url: '@Url.Action("SendMailTokenForRegister", "MemberLogin")',
                    method: 'POST',
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify(postData),
                    success: function (response) {
                        if (response.ErrMsg) {
                            const formData = new FormData(form);
                            registerMember(formData)
                            return false; // 失敗時返回 false
                        }
                        return true; // 成功時返回 true
                    },
                    error: function (err) {
                        $('#ErrorMsg').html(err.responseText);
                        $('#ErrorAlert').modal('toggle');
                        return false; // 失敗時返回 false
                    }
                });             
            }
           
        }

        //DEMO按鈕
        $('#registerdemoBTN').click(function () {
            $('#registerNameText').val("安安");
            $('#registerBirthText').val("01/01/1999");
            $('#emailInput').val("ocarina51006gmail.com")
            $('#registerPhoneText').val("1988657812");
            $('#passwordInput').val("aaa1234");
            $('#passwordCheck').val("aaa123");
        });
        var topAnnouncement = $('.formain-topSpan');
        console.log(topAnnouncement);
        $.ajax({
            url: '@Url.Action("GetTopAnnouncement","ProductApi")',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if (data.success) {
                    topAnnouncement.text(data.message);
                }
                else {
                    topAnnouncement.text(data.messageWelcome);
                }
            },
            error: function () {
                console.log('error');
            }
        });
    </script>



</body>
</html>

